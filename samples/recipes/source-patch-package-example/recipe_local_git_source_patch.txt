Patching Local Git Sources using Git Command for Recipe Build:
==============================================================

1. The existing Recipe local Git repository can be modified by using a Patch file in the Recipe Build.
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build$ cd ../meta-layer/recipes-example/
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/meta-layer/recipes-example$ tree hello-local-git
hello-local-git
└── hello-local-git_0.1.bb

0 directories, 1 file

2. The 'WORKDIR' directory has to be fetched to modify the sources and to generate the Patch file.
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build$ bitbake -e hello-local-git | grep ^WORKDIR=
WORKDIR="/home/prabhat_kiran/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0"
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build$ cd tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0$ ls
configure.sstate   deploy-ipks               git                   license-destdir  pkgdata              pseudo                 source-date-epoch
debugsources.list  deploy-rpms               hello-local-git.spec  package          pkgdata-pdata-input  recipe-sysroot         sysroot-destdir
deploy-debs        deploy-source-date-epoch  image                 packages-split   pkgdata-sysroot      recipe-sysroot-native  temp

3. The sources can be modified in the 'git' directory.
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0$ cd git/
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0/git$ ls
Makefile  program  program.c
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0/git$ vi program.c
---> Update the contents of the C file for generating the Patch file.
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0/git$ vi program.h
---> Add the contents of the Header file to be Built using the Recipe.
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0/git$ ls
Makefile  program  program.c  program.h

4. These changes in the 'git' directory can be tracked on the 'master' branch of the Git repository.
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0/git$ git status
On branch master
Your branch is up to date with 'origin/master'.

Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
	modified:   program.c

Untracked files:
  (use "git add <file>..." to include in what will be committed)
	program
	program.h

no changes added to commit (use "git add" and/or "git commit -a")
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0/git$ git diff
diff --git a/program.c b/program.c
index f8b9b47..6d58119 100644
--- a/program.c
+++ b/program.c
@@ -1,7 +1,14 @@
 #include <stdio.h>
+#include "program.h"

 int main()
 {
        printf ("Hello World from Local Git Repository!\n");
+       display();
        return 0;
 }
+
+void display()
+{
+       printf ("Patched the Source!\n");
+}

5. Since, the changes made to the sources are being tracked by the Git, they must be committed to the 'git' directory to generate the Patch file.
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0/git$ git add program.c
prabhat_kiran@coldstone:~/Documents/.../Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0/git$ git commit -m "Updated the C File"
[master 54d16f4] Updated the C File
 1 file changed, 7 insertions(+)
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0/git$ git add program.h
prabhat_kiran@coldstone:~/Documents/.../Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0/git$ git commit -m "Added the Header File"
[master 4c42639] Added the Header File
 1 file changed, 1 insertion(+)
 create mode 100644 program.h
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0/git$ git format-patch -2 HEAD
0001-Updated-the-C-File.patch
0002-Added-the-Header-File.patch
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0/git$ ls
0001-Updated-the-C-File.patch  0002-Added-the-Header-File.patch  Makefile  program  program.c  program.h

6. Move the Patch files from the 'git' directory to the Recipe folder in the corresponding Meta-Layer.
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/.../hello-local-git/0.1-r0/git$ cp *.patch ../../../../../../../meta-layer/recipes-example/hello-local-git/files/
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0/git$ rm *.patch program.h
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0/git$ ls
Makefile  program  program.c

7. Update the Recipe file in the Recipe folder to include the Patch files in the Recipe Build.
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0/git$ cd ../../../../../../
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build$ cd ../meta-layer/recipes-example/hello-local-git/
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/meta-layer/recipes-example/hello-local-git$ vi hello-local-git_0.1.bb
=> ...
=> SRC_URI = "git:///home/prabhat_kiran/hello-world;branch=master;protocol=file \
=>     file://0001-Updated-the-C-File.patch \
=>     file://0002-Added-the-Header-File.patch \
=> "
=> ...
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/meta-layer/recipes-example/hello-local-git$ cd ..
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/meta-layer/recipes-example$ tree hello-local-git
hello-local-git
├── files
│   ├── 0001-Updated-the-C-File.patch
│   └── 0002-Added-the-Header-File.patch
└── hello-local-git_0.1.bb

1 directory, 3 files

8. To remove all the files and directories generated during the earlier Build, the 'cleanall' command of the BitBake can be used.
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/meta-layer/recipes-example$ cd ../../build/
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build$ bitbake -c cleanall hello-local-git
...
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build$ cd tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0$ rm -rf *

9. On the Host Machine, run the 'bitbake' command with Target as the Recipe name for a quick Build with the Patch files.
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0$ cd ../../../../../
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build$ bitbake hello-local-git
Loading cache: 100% |##############################################################################################################################################| Time: 0:00:00
Loaded 1777 entries from dependency cache.
Parsing recipes: 100% |############################################################################################################################################| Time: 0:00:03
Parsing of 986 .bb files complete (982 cached, 4 parsed). 1781 targets, 159 skipped, 0 masked, 0 errors.
NOTE: Resolving any missing task queue dependencies

Build Configuration:
BB_VERSION           = "2.0.0"
BUILD_SYS            = "x86_64-linux"
NATIVELSBSTRING      = "universal"
TARGET_SYS           = "arm-poky-linux-gnueabi"
MACHINE              = "qemuarm"
DISTRO               = "poky"
DISTRO_VERSION       = "4.0.27"
TUNE_FEATURES        = "arm vfp cortexa15 neon thumb callconvention-hard"
TARGET_FPU           = "hard"
meta
meta-poky
meta-yocto-bsp
meta-layer           = "my-kirkstone:81e0dc80d72d66b7f15a34c0da7a0a8c58809056"
meta-ti-bsp          = "kirkstone:52018a8d730b2977d7163bf56c398905ef9115ac"
meta-arm
meta-arm-toolchain   = "kirkstone:10c27f061b22af78e17a23cf540b69501afc7160"

Initialising tasks: 100% |#########################################################################################################################################| Time: 0:00:00
Sstate summary: Wanted 9 Local 0 Mirrors 0 Missed 9 Current 153 (0% match, 94% complete)
NOTE: Executing Tasks
NOTE: Tasks Summary: Attempted 667 tasks of which 650 didn't need to be rerun and all succeeded.
NOTE: Writing buildhistory
NOTE: Writing buildhistory took: 3 seconds

10. After the Recipe Build is successful, the 'WORKDIR' directory contains all the files and directories generated during the Build.
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build$ cd tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0$ ls
0001-Updated-the-C-File.patch     debugsources.list  deploy-rpms               hello-local-git.spec  package         pkgdata-pdata-input  recipe-sysroot         sysroot-destdir
0002-Added-the-Header-File.patch  deploy-debs        deploy-source-date-epoch  image                 packages-split  pkgdata-sysroot      recipe-sysroot-native  temp
configure.sstate                  deploy-ipks        git                       license-destdir       pkgdata         pseudo               source-date-epoch

11. The 'do_patch' Task execution log is present in the 'temp/log.do_patch' file. The modified sources can be verified in the 'git' directory.
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0$ vi temp/log.do_patch
=> ...
=> DEBUG: Searching for 0001-Updated-the-C-File.patch in paths:
=> ...
=> DEBUG: Searching for 0002-Added-the-Header-File.patch in paths:
=> ...
=> NOTE: Applying patch '0001-Updated-the-C-File.patch' (../meta-layer/recipes-example/hello-local-git/files/0001-Updated-the-C-File.patch)
=> NOTE: Applying patch '0002-Added-the-Header-File.patch' (../meta-layer/recipes-example/hello-local-git/files/0002-Added-the-Header-File.patch)
=> DEBUG: Python function patch_do_patch finished
=> DEBUG: Python function do_patch finished
=> DEBUG: Executing python function do_qa_patch
=> DEBUG: Python function do_qa_patch finished
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0$ ls git/
Makefile  patches  program  program.c  program.h
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0$ ls git/patches
0001-Updated-the-C-File.patch  0002-Added-the-Header-File.patch  series

12. The Recipe must be appended to the 'IMAGE_INSTALL' variable of the Image Recipe for it to be included in the Build.
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/work/cortexa15t2hf-neon-poky-linux-gnueabi/hello-local-git/0.1-r0$ cd ../../../../../
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build$ vi ../meta/recipes-core/images/core-image-minimal.bb
=> IMAGE_INSTALL:append = " hello-local-git"

13. After the Image Recipe file is updated, run the 'bitbake' command with Target Image as 'core-image-minimal' for a quick Build.
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build$ bitbake core-image-minimal
Loading cache: 100% |##############################################################################################################################################| Time: 0:00:00
Loaded 1777 entries from dependency cache.
Parsing recipes: 100% |############################################################################################################################################| Time: 0:00:03
Parsing of 986 .bb files complete (982 cached, 4 parsed). 1781 targets, 159 skipped, 0 masked, 0 errors.
NOTE: Resolving any missing task queue dependencies

Build Configuration:
BB_VERSION           = "2.0.0"
BUILD_SYS            = "x86_64-linux"
NATIVELSBSTRING      = "universal"
TARGET_SYS           = "arm-poky-linux-gnueabi"
MACHINE              = "qemuarm"
DISTRO               = "poky"
DISTRO_VERSION       = "4.0.27"
TUNE_FEATURES        = "arm vfp cortexa15 neon thumb callconvention-hard"
TARGET_FPU           = "hard"
meta
meta-poky
meta-yocto-bsp
meta-layer           = "my-kirkstone:81e0dc80d72d66b7f15a34c0da7a0a8c58809056"
meta-ti-bsp          = "kirkstone:52018a8d730b2977d7163bf56c398905ef9115ac"
meta-arm
meta-arm-toolchain   = "kirkstone:10c27f061b22af78e17a23cf540b69501afc7160"

Initialising tasks: 100% |#########################################################################################################################################| Time: 0:00:02
Sstate summary: Wanted 3 Local 0 Mirrors 0 Missed 3 Current 1402 (0% match, 99% complete)
Removing 2 stale sstate objects for arch qemuarm: 100% |###########################################################################################################| Time: 0:00:00
NOTE: Executing Tasks
NOTE: Tasks Summary: Attempted 3610 tasks of which 3600 didn't need to be rerun and all succeeded.
NOTE: Writing buildhistory
NOTE: Writing buildhistory took: 3 seconds

14. To execute the 'core-image-minimal' Image Built for 'qemuarm' Architecture on QEMU, the below commands can be provided.
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build$ runqemu qemuarm core-image-minimal nographic
runqemu - INFO - Running MACHINE=qemuarm bitbake -e ...
runqemu - INFO - Continuing with the following parameters:
KERNEL: [/home/prabhat_kiran/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/deploy/images/qemuarm/zImage]
MACHINE: [qemuarm]
FSTYPE: [ext4]
ROOTFS: [/home/prabhat_kiran/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/deploy/images/qemuarm/core-image-minimal-qemuarm.ext4]
CONFFILE: [/home/prabhat_kiran/Documents/Learnings/Yocto_Resources/Poky/poky/build/tmp/deploy/images/qemuarm/core-image-minimal-qemuarm.qemuboot.conf]

...

[    0.000000] Booting Linux on physical CPU 0x0
[    0.000000] Linux version 5.15.184-yocto-standard (oe-user@oe-host) (arm-poky-linux-gnueabi-gcc (GCC) 11.5.0, GNU ld (GNU Binutils) 2.38.20220708) ...
[    0.000000] CPU: ARMv7 Processor [412fc0f1] revision 1 (ARMv7), cr=30c5387d
...

Poky (Yocto Project Reference Distro) 4.0.27 qemuarm /dev/ttyAMA0

qemuarm login: root
root@qemuarm:~#

15. The Cross-Compiled C file binary should be located in the directory on which it is installed in the Recipe file along with changes specified in the Patch file.
root@qemuarm:~# ls -l /usr/bin/ | grep "program"
-rwxr-xr-x    1 root     root          5508 Mar  9  2018 program
root@qemuarm:~# program
Hello World from Local Git Repository!
Patched the Source!

16. To exit the QEMU Console, run the below command.
root@qemuarm:~# poweroff

Broadcast message from root@qemuarm (ttyAMA0) (Wed Aug 20 15:04:32 2025):

The system is going down for system halt NOW!
INIT: Switching to runlevel: 0
INIT: Sending processes configured via /etc/inittab the TERM signal
Stopping Dropbear SSH server: stopped /usr/sbin/dropbear (pid 332)
dropbear.
Stopping syslogd/klogd: stopped syslogd (pid 340)
stopped klogd (pid 343)
done
Unmounting remote filesystems...
Deconfiguring network interfaces... ifdown: interface lo not configured
done.
Sending all processes the TERM signal...
Sending all processes the KILL signal...
Deactivating swap...
Unmounting local filesystems...
[  375.735490] EXT4-fs (vda): re-mounted. Opts: (null). Quota mode: disabled.
[  375.954866] reboot: Power down
runqemu - INFO - Cleaning up
runqemu - INFO - Host uptime: 257996.61

Set 'tap0' nonpersistent
prabhat_kiran@coldstone:~/Documents/Learnings/Yocto_Resources/Poky/poky/build$
